schemaVersion: 2.2.0
metadata:
  name: devfile-python-devfile-commands

components:
  - name: python
    container:
      image: python:3.11
      command:
        - sleep
      args:
        - "infinity"
      mountSources: true
  
  # Kubernetes component (this is where k8s content lives)
  - name: demo-k8s-config
    kubernetes:
      uri: k8s/demo-configmap.yaml

commands:
  # ------------------------------------------------------------------
  # 1. Core workflow (real functionality)
  # ------------------------------------------------------------------

  # Newline → implicit &&
  - id: generate-validate-transform
    exec:
      component: python
      commandLine: |
        set -x;
        python -u demo.py generate
        python -u demo.py validate
        python -u demo.py transform

  # Explicit &&
  - id: explicit-and-demo
    exec:
      component: python
      commandLine: |
        set -x;
        python -u demo.py generate && python -u demo.py validate

  # Status inspection
  - id: status
    exec:
      component: python
      commandLine: |
        set -x;
        python -u demo.py status

  # ------------------------------------------------------------------
  # 2. OR operator (||)
  # ------------------------------------------------------------------
  - id: or-demo
    exec:
      component: python
      commandLine: |
        set -x;
        python -u demo.py fail || echo "Recovered from failure"

  # ------------------------------------------------------------------
  # 3. Semicolon chaining (;)
  # ------------------------------------------------------------------
  - id: semicolon-demo
    exec:
      component: python
      commandLine: |
        set -x;
        python -u demo.py status;
        python -u demo.py status

  # ------------------------------------------------------------------
  # 4. Pipe operator (|)
  # ------------------------------------------------------------------
  - id: pipe-demo
    exec:
      component: python
      commandLine: |
        set -x;
        python -u demo.py pipe | grep "service=python" | wc -l

  # ------------------------------------------------------------------
  # 5. POSIX multiline (\) – dlv/docker style
  # ------------------------------------------------------------------
  - id: posix-multiline-demo
    exec:
      component: python
      commandLine: |
        set -x;
        python -u \
          demo.py \
          argv \
          one \
          two \
          three

  # ------------------------------------------------------------------
  # 6. Windows escaped multiline (\\ → \)
  # ------------------------------------------------------------------
  - id: windows-multiline-demo
    exec:
      component: python
      commandLine: |
        set -x;
        python -u \\
          demo.py \\
          argv \\
          win \\
          style

  # ------------------------------------------------------------------
  # 7. Windows backslash normalization function
  # ------------------------------------------------------------------
  - id: windows-backslash-demo
    exec:
      component: python
      commandLine: |
        set -x;
        python -u \\
          demo.py \\
          windows_backslash

  # ------------------------------------------------------------------
  # 8. Subshell grouping ( )
  # ------------------------------------------------------------------
  - id: subshell-demo
    exec:
      component: python
      commandLine: |
        set -x;
        (python -u demo.py generate && python -u demo.py validate) &&
        python -u demo.py transform

  # ------------------------------------------------------------------
  # 9. Background execution (&) + wait
  # ------------------------------------------------------------------
  - id: background-demo
    exec:
      component: python
      commandLine: |
        set -x;
        python -u demo.py pipe &
        python -u demo.py pipe &
        wait

  # ------------------------------------------------------------------
  # 10. Simple multiline → auto &&
  # ------------------------------------------------------------------
  - id: simple-chain
    exec:
      component: python
      commandLine: |
        set -x;
        python -u demo.py generate
        python -u demo.py validate
        python -u demo.py status

  # ------------------------------------------------------------------
  # 11. Trailing && cleanup case
  # ------------------------------------------------------------------
  - id: trailing-and-demo
    exec:
      component: python
      commandLine: |
        set -x;
        echo "hello world" &&

  # ------------------------------------------------------------------
  # 12. Cyclic composite (must be rejected)
  # ------------------------------------------------------------------

  - id: cycle-a
    composite:
      commands:
        - cycle-b

  - id: cycle-b
    composite:
      commands:
        - cycle-a

  # ------------------------------------------------------------------
  # 13. Command Groups (build / run / test / debug)
  # ------------------------------------------------------------------

  - id: build-demo
    exec:
      component: python
      commandLine: python -u demo.py generate
      group:
        kind: build
        isDefault: true
      label: Build → Generate data

  - id: test-demo
    exec:
      component: python
      commandLine: python -u demo.py validate
      group:
        kind: test
      label: Test → Validate data

  - id: run-demo
    exec:
      component: python
      commandLine: python -u demo.py status
      group:
        kind: run
      label: Run → Show status

  - id: debug-demo
    exec:
      component: python
      commandLine: python -u demo.py argv debug
      group:
        kind: debug
      label: Debug → Show argv flow

  # ------------------------------------------------------------------
  # 14. workingDir demo
  # ------------------------------------------------------------------

  - id: workingdir-demo
    exec:
      component: python
      workingDir: /projects
      commandLine: pwd
      label: Execute from custom workingDir

  # ------------------------------------------------------------------
  # 15. Apply command (Kubernetes resource)
  # Requires k8s/demo-configmap.yaml
  # ------------------------------------------------------------------

  - id: apply-k8s-resource
    apply:
      component: demo-k8s-configs
      label: Apply Kubernetes ConfigMap

  # ------------------------------------------------------------------
  # Set composite mode commands
  # ------------------------------------------------------------------

  # Set mode = sequential
  - id: set-sequential
    exec:
      component: python
      commandLine: |
        echo "Sequential" > .composite_mode
        echo "Mode written: Sequential"

  # Set mode = parallel
  - id: set-parallel
    exec:
      component: python
      commandLine: |
        echo "Parallel" > .composite_mode
        echo "Mode written: Parallel"

  # ------------------------------------------------------------------
  # Print composite execution start banner
  # ------------------------------------------------------------------
  - id: composite-start
    exec:
      component: python
      commandLine: |
        MODE=$(cat .composite_mode 2>/dev/null || echo "unknown")
        echo "======================================"
        echo "Composite execution started"
        echo "Mode      : ${MODE}"
        echo "======================================"

  # ------------------------------------------------------------------
  # 16. Composite: sequential workflow
  # ------------------------------------------------------------------
  - id: sequential-demo
    composite:
      commands:
        - set-sequential
        - composite-start
        - build-demo
        - test-demo
        - run-demo
        - apply-k8s-resource
      parallel: false

  # ------------------------------------------------------------------
  # 17. Composite: parallel diagnostics
  # ------------------------------------------------------------------
  - id: parallel-demo
    composite:
      commands:
        - set-parallel
        - composite-start
        - build-demo
        - test-demo
        - run-demo
        - debug-demo
        - apply-k8s-resource
      parallel: true

  # ------------------------------------------------------------------
  # 18. Component signaling demo
  # ------------------------------------------------------------------
  - id: signal-backend
    exec:
      component: backend
      commandLine: python -u demo.py component_signal --component backend

  - id: signal-frontend
    exec:
      component: frontend
      commandLine: python -u demo.py component_signal --component frontend
  
  - id: component-seq-demo 
    composite:
      commands:
        - signal-backend
        - signal-frontend
      parallel: false
  
  - id: component-parallel-demo
    composite:
      commands:
        - signal-backend
        - signal-frontend
      parallel: true
