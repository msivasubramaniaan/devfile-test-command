schemaVersion: 2.2.0
metadata:
  name: devfile-python-devfile-commands

components:
  - name: python
    container:
      image: python:3.11
      command:
        - sleep
      args:
        - "infinity"
      mountSources: true

commands:
  # ------------------------------------------------------------------
  # 1. Core workflow (real functionality)
  # ------------------------------------------------------------------

  # Newline → implicit &&
  - id: generate-validate-transform
    exec:
      component: python
      commandLine: |
        set -x;
        python -u demo.py generate
        python -u demo.py validate
        python -u demo.py transform

  # Explicit &&
  - id: explicit-and-demo
    exec:
      component: python
      commandLine: |
        set -x;
        python -u demo.py generate && python -u demo.py validate

  # Status inspection
  - id: status
    exec:
      component: python
      commandLine: |
        set -x;
        python -u demo.py status

  # ------------------------------------------------------------------
  # 2. OR operator (||)
  # ------------------------------------------------------------------
  - id: or-demo
    exec:
      component: python
      commandLine: |
        set -x;
        python -u demo.py fail || echo "Recovered from failure"

  # ------------------------------------------------------------------
  # 3. Semicolon chaining (;)
  # ------------------------------------------------------------------
  - id: semicolon-demo
    exec:
      component: python
      commandLine: |
        set -x;
        python -u demo.py status;
        python -u demo.py status

  # ------------------------------------------------------------------
  # 4. Pipe operator (|)
  # ------------------------------------------------------------------
  - id: pipe-demo
    exec:
      component: python
      commandLine: |
        set -x;
        python -u demo.py pipe | grep "service=python" | wc -l

  # ------------------------------------------------------------------
  # 5. POSIX multiline (\) – dlv/docker style
  # ------------------------------------------------------------------
  - id: posix-multiline-demo
    exec:
      component: python
      commandLine: |
        set -x;
        python -u \
          demo.py \
          argv \
          one \
          two \
          three

  # ------------------------------------------------------------------
  # 6. Windows escaped multiline (\\ → \)
  # ------------------------------------------------------------------
  - id: windows-multiline-demo
    exec:
      component: python
      commandLine: |
        set -x;
        python -u \\
          demo.py \\
          argv \\
          win \\
          style

  # ------------------------------------------------------------------
  # 7. Windows backslash normalization function
  # ------------------------------------------------------------------
  - id: windows-backslash-demo
    exec:
      component: python
      commandLine: |
        set -x;
        python -u \\
          demo.py \\
          windows_backslash

  # ------------------------------------------------------------------
  # 8. Subshell grouping ( )
  # ------------------------------------------------------------------
  - id: subshell-demo
    exec:
      component: python
      commandLine: |
        set -x;
        (python -u demo.py generate && python -u demo.py validate) &&
        python -u demo.py transform

  # ------------------------------------------------------------------
  # 9. Background execution (&) + wait
  # ------------------------------------------------------------------
  - id: background-demo
    exec:
      component: python
      commandLine: |
        set -x;
        python -u demo.py pipe &
        python -u demo.py pipe &
        wait

  # ------------------------------------------------------------------
  # 10. Simple multiline → auto &&
  # ------------------------------------------------------------------
  - id: simple-chain
    exec:
      component: python
      commandLine: |
        set -x;
        python -u demo.py generate
        python -u demo.py validate
        python -u demo.py status

  # ------------------------------------------------------------------
  # 11. Trailing && cleanup case
  # ------------------------------------------------------------------
  - id: trailing-and-demo
    exec:
      component: python
      commandLine: |
        set -x;
        echo "hello world" &&

  # ------------------------------------------------------------------
  # Set composite mode commands
  # ------------------------------------------------------------------

  # Set mode = sequential
  - id: set-sequential
    exec:
      component: python
      commandLine: |
        echo "Sequential" > .composite_mode
        echo "Mode written: Sequential"

  # Set mode = parallel
  - id: set-parallel
    exec:
      component: python
      commandLine: |
        echo "Parallel" > .composite_mode
        echo "Mode written: Parallel"


  # ------------------------------------------------------------------
  # Print composite execution start banner
  # ------------------------------------------------------------------
  - id: composite-start
    exec:
      component: python
      commandLine: |
        MODE=$(cat .composite_mode 2>/dev/null || echo "unknown")
        echo "======================================"
        echo "Composite execution started"
        echo "Mode      : ${MODE}"
        echo "======================================"

  # ------------------------------------------------------------------
  # 12. Composite: sequential workflow
  # ------------------------------------------------------------------
  - id: sequential-demo
    composite:
      commands:
        - set-sequential
        - composite-start
        - generate-validate-transform
        - pipe-demo
        - or-demo
        - posix-multiline-demo
        - windows-multiline-demo
      parallel: false

  # ------------------------------------------------------------------
  # 13. Composite: parallel diagnostics
  # ------------------------------------------------------------------
  - id: parallel-demo
    composite:
      commands:
        - set-parallel
        - composite-start
        - pipe-demo
        - semicolon-demo
        - windows-backslash-demo
      parallel: true

  # ------------------------------------------------------------------
  # 14. Cyclic composite (must be rejected)
  # ------------------------------------------------------------------

  - id: cycle-a
    composite:
      commands:
        - cycle-b

  - id: cycle-b
    composite:
      commands:
        - cycle-a
